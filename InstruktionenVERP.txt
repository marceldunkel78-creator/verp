
Backend abhängigkeiten:
cd backend
python -m venv venv
.\venv\Scripts\Activate
pip install -r requirements.txt

migrationen: 
cd backend
python manage.py makemigrations
python manage.py migrate


Umgebungsvariablen konfigurieren (.env Datei):
- Kopiere backend/.env.example nach backend/.env
- Passe die Werte an:

  # Django Settings
  SECRET_KEY=dein-sicherer-key-hier
  DJANGO_DEBUG=True
  ALLOWED_HOSTS=localhost,127.0.0.1

  # Database
  DB_NAME=verp_db
  DB_USER=verp_user
  DB_PASSWORD=verp_password
  DB_HOST=localhost
  DB_PORT=5432

  # Media Storage - Absoluter Pfad zum externen Medienordner
  MEDIA_ROOT=C:/VERP-Media
  
  # Media Base URL - Für Produktion (falls Backend unter anderer URL als Frontend läuft)
  # Beispiel: MEDIA_BASE_URL=http://verp.intern.local
  # Falls nicht gesetzt, wird die URL automatisch aus dem Request generiert
  # MEDIA_BASE_URL=

- Generiere einen sicheren SECRET_KEY:
  cd backend
  python tools/generate_secret_key.py



Superuser erstellen bei activated venv
python manage.py createsuperuser


Firmeneinstellungen konfigurieren:
1. Admin-Interface öffnen: http://localhost:8000/admin
2. Unter "Firmeneinstellungen" → "Company Settings" die Firmendaten eintragen
3. Dokument-Header hochladen (visitron_document_header.png)
4. Bankverbindung, Geschäftsführer, Handelsregister-Nr. eintragen



entwicklungsserver starten :

# Backend (Terminal 1)
cd backend
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\venv\Scripts\Activate
python manage.py runserver

# Frontend (Terminal 2)
cd frontend
npm start


# Ins Backend-Verzeichnis wechseln
cd backend

# DRY-RUN (Vorschau ohne Änderungen)
python import_addresses.py

# ECHTER IMPORT (importiert ~7.500 Kunden mit Adressen, Telefonnummern, E-Mails)
python import_addresses.py --live

# Hinweis: Der Import filtert automatisch Lieferanten und veraltete Adressen aus.
# Bei identischen Namen werden mehrere Adressen dem selben Kunden zugeordnet.
# Felder die zu lang sind werden automatisch gekürzt (Stadt: 100, Straße: 200, Tel: 50 Zeichen)

VisiView Lizenezn aktualisieren
cd backend
# Dry-run mit detaillierten Match-Infos
python import_visiview_licenses.py "C:\Users\mdunk\Documents\VERP\Datenvorlagen\Licenses.csv"

# Live-Run mit per-row Ausgabe
python import_visiview_licenses.py "C:\Users\mdunk\Documents\VERP\Datenvorlagen\Licenses.csv" --live --verbose

# Optional: Relinking erlauben (falls bestehende Verknüpfung korrigiert werden soll)
python import_visiview_licenses.py "C:\Users\mdunk\Documents\VERP\Datenvorlagen\Licenses.csv" --live --verbose --relink

cd backend
python import_visiview_macros.py --dry-run
python import_visiview_macros.py

Next steps: run a dry-run first:
python backend/delete_supplier_and_incoming.py --number 104
If output looks correct, run with --yes to perform deletion.

favicons generieren: 
cd frontend
# sicherstellen, dass frontend/public/VERP.svg vorhanden ist
npm run generate-favicons

python import_maintenance_data.py --license-id 1598


cd c:\Users\mdunk\Documents\VERP\backend
dry run
python import_legacy_orders.py --limit 100
live
python import_legacy_orders.py --live

um bei den Systemen die Kundenadresse als systemadresse zu übernehmen: 
cd backend
..\.venv\Scripts\python.exe migrate_system_locations.py

update nach Änderung
cd C:\VERP
git pull origin main
cd C:\VERP
python manage.py migrate
Restart-Service VERP-Backend

bzw. 
cd C:\VERP
git pull origin main

cd C:\VERP\frontend
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
npm run build
Copy-Item C:\VERP\scripts\web.config.template C:\VERP\frontend\build\web.config -Force
iisreset


# Backup/Update Scripte (Windows Server)

# Backup ausführen (Standardziel: Z:\VERP-Backup)
cd C:\VERP\scripts
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\backup-verp.ps1

# Update ausführen inkl. Backup
cd C:\VERP\scripts
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\update-verp.ps1

# Update ohne Backup
cd C:\VERP\scripts
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
.\update-verp.ps1 -SkipBackup

# Parameter (optional)
# backup-verp.ps1: -VerpRoot "C:\VERP" -BackupDir "Z:\VERP-Backup" -MediaDir "C:\VERP-Media" -RetentionDays 30
# update-verp.ps1: -VerpRoot "C:\VERP" -BackupDir "Z:\VERP-Backup" -SkipBackup

# Was passiert beim Backup?
# - Datenbank-Dump (verp_db.dump) wird unter Z:\VERP-Backup\YYYY-MM-DD gespeichert
# - Media-Ordner wird per robocopy gespiegelt (inkrementell)
# - .env und web.config werden in Z:\VERP-Backup\YYYY-MM-DD\Config gesichert
# - Alte Backups > RetentionDays werden gelöscht

# Was passiert beim Update?
# - Optionales Backup
# - Backend-Dienst stoppen
# - Git Pull
# - Backend: venv, pip install, migrate, collectstatic
# - Frontend: npm install, npm run build
# - web.config wiederherstellen
# - Backend-Dienst starten

# Backup wiederherstellen (manuell)
# 1) Datenbank wiederherstellen
#    - Datei: Z:\VERP-Backup\YYYY-MM-DD\verp_db.dump
#    - pg_restore (Beispiel):
#      "C:\Program Files\PostgreSQL\18\bin\pg_restore.exe" -U verp_user -h localhost -d verp_db -c "Z:\VERP-Backup\YYYY-MM-DD\verp_db.dump"
# 2) Media-Ordner zurückspielen
#      robocopy "Z:\VERP-Backup\YYYY-MM-DD\Media" "C:\VERP-Media" /MIR /R:3 /W:5
# 3) Config zurückspielen
#      Copy-Item "Z:\VERP-Backup\YYYY-MM-DD\Config\.env.backend" "C:\VERP\backend\.env" -Force
#      Copy-Item "Z:\VERP-Backup\YYYY-MM-DD\Config\web.config" "C:\VERP\frontend\build\web.config" -Force
# 4) Dienst neu starten
#      Restart-Service VERP-Backend

JSON: Nein, Backup/Restore ist nicht problematisch.
Das ist ein typisches Problem nach Restore/Import: Die Sequenzen (Auto‑ID‑Zähler) werden nicht automatisch auf MAX(id) gesetzt. Daher entstehen „duplicate key“ Fehler.

So ist es sauber:

Nach Restore einmal fix_sequences.py laufen lassen.
Danach ist alles wieder stabil.
Wenn du willst, kann ich das Update/Restore-Script so anpassen, dass fix_sequences.py automatisch nach dem Restore läuft.